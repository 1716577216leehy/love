<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç»™æ³½é’°çš„ä¸“å±å°çª</title>
  <style>
    /* âœ¨ å…¨å±€æ ·å¼ */
    body { margin: 0; font-family: "Microsoft YaHei", sans-serif; overflow: hidden; }
    
    /* ğŸŒ¸ èƒŒæ™¯å±‚ */
    #bg-layer {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-size: cover; background-position: center;
      filter: blur(15px) brightness(0.9);
      transition: background-image 1.5s ease-in-out;
      z-index: -1;
    }

    /* ğŸ“¦ å¸ƒå±€å®¹å™¨ */
    .center {
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      height: 100vh; text-align: center; color: #5a2a2a;
      animation: fadeIn 0.8s ease; position: relative; z-index: 1;
    }
    .hidden { display: none !important; }

    /* ğŸ”˜ æŒ‰é’® */
    button {
      padding: 12px 24px; font-size: 16px; border-radius: 50px; border: none;
      background: rgba(255, 143, 171, 0.95); color: white; cursor: pointer; margin: 8px;
      box-shadow: 0 4px 12px rgba(255, 111, 145, 0.3); transition: transform 0.2s;
    }
    button:hover { transform: scale(1.05); background: #ff6f91; }

    /* ğŸ“ è¾“å…¥æ¡† */
    textarea {
      width: 80%; max-width: 400px; height: 100px; padding: 10px; border-radius: 10px;
      border: 2px solid #ffc2d1; background: rgba(255,255,255,0.9); outline: none;
    }

    /* ğŸ“¸ ç›¸å†Œç½‘æ ¼ */
    #gallery-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 8px; width: 90%; max-width: 500px; max-height: 40vh; overflow-y: auto;
      background: rgba(255,255,255,0.5); padding: 10px; border-radius: 12px; margin-bottom: 15px;
    }
    .photo-item { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 6px; cursor: pointer; }

    /* ğŸµ éŸ³ä¹æ§ä»¶ */
    .music-player { position: fixed; top: 15px; right: 15px; z-index: 10; background: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 20px; font-size: 12px; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<div id="bg-layer"></div>

<div class="music-player">
  <span>ğŸµ BGM </span>
  <button style="padding:4px 8px; font-size:12px; margin:0;" onclick="togglePlay()">â¯</button>
</div>
<audio id="audio" loop></audio>

<div id="cover" class="center">
  <h1 style="font-size: 2rem; text-shadow: 0 2px 4px rgba(255,255,255,0.5);">ğŸ  ç»™æ³½é’°çš„å°çª</h1>
  <button onclick="enterHome()">æ•²é—¨è¿›å…¥ â¤ï¸</button>
</div>

<div id="home" class="center hidden">
  <h2>æ¬¢è¿å›å®¶</h2>
  <div>
    <button onclick="switchPage('album')">ğŸ“¸ äº‘ç›¸å†Œ</button>
    <button onclick="switchPage('now')">âœï¸ è®°å¿ƒæƒ…</button>
    <button onclick="switchPage('miss')">ğŸ’¬ æƒ³ä½ äº†</button>
  </div>
</div>

<div id="album" class="center hidden">
  <h3>ğŸ“¸ æˆ‘ä»¬çš„å›å¿† (å®æ—¶åŒæ­¥)</h3>
  <div id="gallery-grid"><p style="font-size:12px">åŠ è½½ä¸­...</p></div>
  
  <input type="file" id="uploadInput" accept="image/*" style="display: none;" onchange="uploadImage(this)">
  <button onclick="document.getElementById('uploadInput').click()" style="background:#a2d2ff;">â• ä¸Šä¼ ç…§ç‰‡ (è‡ªåŠ¨åŒæ­¥)</button>
  <button onclick="switchPage('home')">è¿”å›</button>
</div>

<div id="now" class="center hidden">
  <h3>âœï¸ å†™ç»™æˆ‘çš„è¯</h3>
  <textarea id="moodInput" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ..."></textarea><br>
  <button onclick="saveMood()">ä¿å­˜</button>
  <button onclick="switchPage('home')">è¿”å›</button>
</div>

<div id="miss" class="center hidden">
  <h3>Don't Worry</h3>
  <p>æ— è®ºå¤šæ™šï¼Œæˆ‘éƒ½åœ¨ã€‚</p>
  <button onclick="switchPage('home')">è¿”å›</button>
</div>

<script>
  /* === é…ç½®åŒº === */
  const defaultBgs = ["bg/1.jpg", "bg/2.jpg", "bg/3.jpg"]; // ç¡®ä¿bgæ–‡ä»¶å¤¹é‡Œæœ‰è¿™äº›å›¾
  const songs = ["music/song1.mp3", "music/song2.mp3"];   // ç¡®ä¿musicæ–‡ä»¶å¤¹é‡Œæœ‰è¿™äº›æ­Œ
  
  let allImages = [...defaultBgs];
  let bgIndex = 0;
  let audio = document.getElementById("audio");

  /* === åˆå§‹åŒ– === */
  window.onload = function() {
    loadCloudImages(); // ä»äº‘ç«¯æ‹‰å–å›¾ç‰‡
    setInterval(nextBg, 8000); // 8ç§’æ¢èƒŒæ™¯
    changeBg(defaultBgs[0]);
    audio.src = songs[0];
  };

  function enterHome() {
    switchPage('home');
    audio.play().catch(() => console.log("éœ€äº¤äº’æ‰èƒ½æ’­æ”¾"));
  }

  function switchPage(id) {
    document.querySelectorAll('.center').forEach(el => el.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  /* === èƒŒæ™¯è½®æ’­ === */
  function changeBg(url) {
    document.getElementById("bg-layer").style.backgroundImage = `url('${url}')`;
  }
  function nextBg() {
    bgIndex = (bgIndex + 1) % allImages.length;
    changeBg(allImages[bgIndex]);
  }

  /* === äº‘ç«¯æ ¸å¿ƒé€»è¾‘ (APIè°ƒç”¨) === */
  
  // 1. è·å–äº‘ç«¯å›¾ç‰‡åˆ—è¡¨
  async function loadCloudImages() {
    try {
      const res = await fetch('/api/list'); // è°ƒç”¨ functions/api/list.js
      if (res.ok) {
        const cloudData = await res.json();
        // åˆå¹¶é»˜è®¤å›¾ç‰‡å’Œäº‘ç«¯å›¾ç‰‡
        allImages = defaultBgs.concat(cloudData);
        renderGallery();
      }
    } catch (err) { console.error("äº‘ç«¯è¿æ¥å¤±è´¥", err); renderGallery(); }
  }

  // 2. ä¸Šä¼ å›¾ç‰‡
  async function uploadImage(input) {
    const file = input.files[0];
    if (!file) return;
    
    // å‹ç¼©/é™åˆ¶å¤§å° (è¿™é‡Œç®€å•é™åˆ¶2MBï¼Œé˜²æ­¢KVæº¢å‡º)
    if (file.size > 2 * 1024 * 1024) return alert("å›¾ç‰‡å¤ªå¤§äº†ï¼Œè¯·é€‰å¼ å°ç‚¹çš„(2MBå†…)ğŸ¥º");

    const reader = new FileReader();
    reader.onload = async function(e) {
      const base64 = e.target.result;
      
      // ä¹è§‚æ›´æ–°ï¼šå…ˆåœ¨æœ¬åœ°æ˜¾ç¤ºï¼Œä¸ç­‰æœåŠ¡å™¨
      allImages.push(base64);
      changeBg(base64);
      renderGallery();
      alert("æ­£åœ¨åå°ä¸Šä¼ ï¼Œè¯·ç¨ç­‰...");

      // å‘é€ç»™ Cloudflare
      try {
        await fetch('/api/upload', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ image: base64, time: Date.now() })
        });
        alert("âœ… ä¸Šä¼ æˆåŠŸï¼ä»¥åæ‰“å¼€éƒ½åœ¨ï¼");
      } catch (err) {
        alert("âŒ ä¸Šä¼ å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜");
      }
    };
    reader.readAsDataURL(file);
  }

  function renderGallery() {
    const grid = document.getElementById("gallery-grid");
    grid.innerHTML = "";
    // å€’åºæ˜¾ç¤ºï¼Œæ–°çš„åœ¨å‰
    [...allImages].reverse().forEach(src => {
      let img = document.createElement("img");
      img.src = src;
      img.className = "photo-item";
      img.onclick = () => changeBg(src);
      grid.appendChild(img);
    });
  }

  /* === å…¶ä»–åŠŸèƒ½ === */
  function togglePlay() { audio.paused ? audio.play() : audio.pause(); }
  
  function saveMood() {
    const val = document.getElementById("moodInput").value;
    if(val) { alert("å·²ä¿å­˜åˆ°æœ¬åœ° (æ­¤å¤„æœªæ¥äº‘ç«¯)"); document.getElementById("moodInput").value = ""; }
  }
</script>
</body>
</html>