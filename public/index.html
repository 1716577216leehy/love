<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»™é»„æ³½é’°æ­çš„å°çª</title>
    <style>
        :root {
            --soft-pink: #ffc2d1; --light-pink: #fff0f3; --deep-pink: #fb6f92;
            --boy-blue: #a2d2ff; --glass: rgba(255, 255, 255, 0.75);
            --xmas-red: #d62828; --xmas-green: #2d6a4f;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'PingFang SC', sans-serif; color: #555; overflow: hidden; }
        #bg-slider { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: linear-gradient(135deg, #ffe5ec 0%, #ffc2d1 100%); transition: 1s; }
        body.birthday-theme #bg-slider { background: linear-gradient(135deg, var(--xmas-red) 0%, var(--xmas-green) 100%) !important; }

        .decoration { position: fixed; top: -50px; z-index: 99; pointer-events: none; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); } }

        #music-player { position: fixed; top: 20px; right: 20px; z-index: 100; background: var(--glass); padding: 12px 20px; border-radius: 30px; backdrop-filter: blur(10px); display: flex; align-items: center; gap: 12px; border: 1px solid white; }
        
        .container { height: 100vh; display: flex; justify-content: center; align-items: center; perspective: 1000px; }
        .card { background: var(--glass); padding: 2.5rem; border-radius: 35px; box-shadow: 0 15px 40px rgba(0,0,0,0.05); backdrop-filter: blur(15px); border: 2px solid white; text-align: center; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; position: relative; }

        /* åŠ¨ç”»é€»è¾‘ */
        @keyframes pageIn {
            0% { opacity: 0; transform: rotateY(-20deg) scale(0.9) translateX(50px); filter: blur(5px); }
            100% { opacity: 1; transform: rotateY(0deg) scale(1) translateX(0); filter: blur(0); }
        }
        .page-animate { animation: pageIn 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards; }

        .btn { padding: 12px 25px; border: none; border-radius: 25px; cursor: pointer; transition: 0.3s; font-size: 1rem; margin: 10px; background: white; color: var(--deep-pink); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .btn-primary { background: var(--deep-pink); color: white; }
        
        .hidden { display: none; }
        .memo-item { margin: 10px 0; padding: 15px; border-radius: 20px; font-size: 14px; background: white; text-align: left; }
    </style>
</head>
<body>
    <div id="bg-slider"></div>
    <div id="music-player">
        <button onclick="prevMusic()">â®ï¸</button>
        <button id="play-btn" onclick="toggleMusic()">â–¶ï¸</button>
        <button onclick="nextMusic()">â­ï¸</button>
    </div>

    <div class="container">
        <div id="login-page" class="card">
            <h1 style="color: var(--deep-pink);">ç»™é»„æ³½é’°æ­çš„å°çª</h1>
            <button class="btn btn-primary" onclick="login('é»„æ³½é’°')">æˆ‘æ˜¯ é»„æ³½é’° ğŸŒ¸</button>
            <button class="btn" style="color:#a2d2ff" onclick="login('æé¸¿è¿')">æˆ‘æ˜¯ æé¸¿è¿ â˜ï¸</button>
        </div>

        <div id="birthday-guide" class="card hidden">
            <div id="guide-content" style="font-size: 1.3rem; line-height: 1.6; color: var(--xmas-red); font-weight: bold;"></div>
            <div id="guide-input-box" class="hidden">
                <textarea id="birthday-wish-input" placeholder="åœ¨è¿™é‡Œå†™ä¸‹æ„¿æœ›..." style="width:100%; height:100px; border-radius:20px; padding:15px; border:1px solid var(--soft-pink);"></textarea>
            </div>
            <button id="guide-next-btn" class="btn btn-primary" onclick="nextGuidePage()">ç»§ç»­ âœ¨</button>
        </div>

        <div id="main-page" class="card hidden">
            <div id="birthday-timer-box" class="hidden" style="color: var(--xmas-red); font-size: 1.2rem; margin-bottom: 15px;">ç¥é»„æ³½é’°å°æœ‹å‹ç”Ÿæ—¥å¿«ä¹ï¼ğŸ</div>
            <div id="normal-timer-box" class="hidden" style="color: var(--deep-pink); margin-bottom: 15px;">æˆ‘ä»¬å·²ç»åœ¨ä¸€èµ· <span id="days-count">0</span> å¤©</div>
            <h2 id="welcome-msg"></h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="btn" onclick="showGroups()" style="background:white; padding:20px; border-radius:20px; cursor:pointer;">ğŸ“· ç›¸å†Œ</div>
                <div class="btn" onclick="showSection('memo')" style="background:white; padding:20px; border-radius:20px; cursor:pointer;">ğŸ“– å›å¿†å½•</div>
                <div id="wish-btn" class="btn hidden" onclick="showSection('wish')" style="background:#fff0f3; padding:20px; border-radius:20px; cursor:pointer;">ğŸŒŸ æ„¿æœ›</div>
                <div class="btn" onclick="missYou()" style="background:white; padding:20px; border-radius:20px; cursor:pointer;">â¤ï¸ æƒ³ä½ äº†</div>
            </div>
        </div>

        <div id="content-page" class="card hidden">
            <div id="page-detail"></div>
            <hr style="border: 0.5px solid #ffe5ec; margin: 20px 0;">
            <div id="bottom-controls"></div>
            <button class="btn" onclick="backToMain()">â¬…ï¸ è¿”å›ä¸»é¡µ</button>
        </div>
    </div>

    <audio id="audio-element"></audio>

    <script>
        let currentUser = "";
        let currentGuideIdx = 0;
        const playlist = ["https://files.catbox.moe/p9p66j.mp3","https://music.163.com/song/media/outer/url?id=1355147134.mp3"];
        const audio = document.getElementById('audio-element');

        function login(user) {
            const pwd = prompt(`è¯·è¾“å…¥å¯†ç  (${user}):`);
            if (user === 'é»„æ³½é’°' && pwd === 'ilovelhy') {
                currentUser = user; 
                initAudio();
                const now = new Date();
                if (now.getMonth() + 1 === 12 && now.getDate() === 24) startBirthdayGuide();
                else enterMain();
            } else if (user === 'æé¸¿è¿' && pwd === 'ilovehzy') {
                currentUser = user; initAudio(); enterMain();
            } else alert("å£ä»¤ä¸å¯¹å“¦~");
        }

        function startBirthdayGuide() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('birthday-guide').classList.remove('hidden');
            document.body.classList.add('birthday-theme');
            startSnow();
            nextGuidePage();
        }

        const guideTexts = [
            "ä½ å¥½~ é»„æ³½é’°å°æœ‹å‹~",
            "è¿™æ˜¯ä¸€å°æå‰ä¸ºä½ å‡†å¤‡çš„ä¿¡...",
            "æˆ‘ä»¬åœ¨ä¸€èµ·å·²ç» {days} å¤©äº†",
            "æˆ‘ä»¬å·²ç»ä¸€èµ·èµ°è¿‡äº†é‚£~~~~ä¹ˆè¿œ",
            "ä»Šå¤©æ˜¯ä¸ªç‰¹åˆ«çš„æ—¥å­",
            "è¦ç¥æˆ‘ä»¬çš„å°å¯¿æ˜Ÿç”Ÿæ—¥å¿«ä¹~",
            "å†™ä¸‹ä½ çš„ç”Ÿæ—¥æ„¿æœ›å§~ä¸‡ä¸€ä¼šå®ç°å‘¢",
            "ç”Ÿæ—¥æ„¿æœ›è¾“å…¥é¡µ"
        ];

        function nextGuidePage() {
            currentGuideIdx++;
            const content = document.getElementById('guide-content');
            const nextBtn = document.getElementById('guide-next-btn');
            const inputBox = document.getElementById('guide-input-box');

            if (currentGuideIdx > guideTexts.length) {
                enterMain(); return;
            }

            let text = guideTexts[currentGuideIdx-1];
            if (text.includes("{days}")) {
                const diff = new Date() - new Date(2026, 0, 9, 22, 51);
                text = text.replace("{days}", Math.floor(diff / (1000*60*60*24)));
            }

            if (currentGuideIdx === 8) {
                content.innerText = "åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„æ„¿æœ›ï¼š";
                inputBox.classList.remove('hidden');
                nextBtn.innerText = "ä¿å­˜å¹¶è¿›å…¥å°çª ğŸ";
                nextBtn.onclick = saveBirthdayWish;
            } else {
                content.innerText = text;
            }
            triggerTransition('birthday-guide');
        }

        async function saveBirthdayWish() {
            const val = document.getElementById('birthday-wish-input').value;
            if(val) await api('addWish', { content: val });
            enterMain();
        }

        function enterMain() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('birthday-guide').classList.add('hidden');
            document.getElementById('main-page').classList.remove('hidden');
            document.getElementById('welcome-msg').innerText = "ä½ å¥½å‘€, " + currentUser;
            
            const now = new Date();
            const isBD = (now.getMonth() + 1 === 12 && now.getDate() === 24);
            if (isBD) {
                document.getElementById('birthday-timer-box').classList.remove('hidden');
                document.getElementById('wish-btn').classList.remove('hidden');
                document.body.classList.add('birthday-theme');
                startSnow();
            } else {
                document.getElementById('normal-timer-box').classList.remove('hidden');
                const diff = new Date() - new Date(2026, 0, 9, 22, 51);
                document.getElementById('days-count').innerText = Math.floor(diff / (1000*60*60*24));
            }
            triggerTransition('main-page');
        }

        async function showSection(type) {
            document.getElementById('main-page').classList.add('hidden');
            const page = document.getElementById('content-page');
            const detail = document.getElementById('page-detail');
            page.classList.remove('hidden');
            triggerTransition('content-page');

            if (type === 'wish') {
                const wishes = await api('getWishes');
                detail.innerHTML = `<h3>ä½ çš„æ„¿æœ›æ¸…å• ğŸŒŸ</h3><div id="wish-list"></div>`;
                wishes.reverse().forEach(w => {
                    const div = document.createElement('div');
                    div.className = 'memo-item';
                    div.innerHTML = `<small style="color:#888">${w.time}</small><br><b>${w.content}</b><br><button class="btn" style="font-size:12px; padding:5px 10px;" onclick="deleteWish(${w.id})">åˆ é™¤</button>`;
                    detail.appendChild(div);
                });
            } else if (type === 'memo') {
                const logs = await api('getMemos');
                detail.innerHTML = `<h3>å›å¿†å½•</h3><div id="memo-list" style="display:flex;flex-direction:column;gap:10px;max-height:350px;overflow-y:auto"></div>`;
                logs.reverse().forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'memo-item';
                    div.innerHTML = `<small>${item.time}</small><br><b>${item.user}:</b> ${item.content}`;
                    document.getElementById('memo-list').appendChild(div);
                });
            }
        }

        async function deleteWish(id) { if(confirm('è¦åˆ é™¤è¿™ä¸ªæ„¿æœ›å—ï¼Ÿ')) { await api('delWish', {id}); showSection('wish'); } }
        async function api(action, data = {}) {
            const res = await fetch('/api/data', { method: 'POST', body: JSON.stringify({ action, user: currentUser, ...data }) });
            return res.json();
        }
        function triggerTransition(id) { const el = document.getElementById(id); el.classList.remove('page-animate'); void el.offsetWidth; el.classList.add('page-animate'); }
        function startSnow() {
            setInterval(() => {
                const dec = document.createElement('div'); dec.className = 'decoration';
                dec.innerText = ['â„ï¸', 'ğŸ°', 'ğŸ„', 'ğŸ'][Math.floor(Math.random()*4)];
                dec.style.left = Math.random()*100 + 'vw'; dec.style.animationDuration = Math.random()*3+4+'s';
                document.body.appendChild(dec); setTimeout(() => dec.remove(), 7000);
            }, 500);
        }
        function initAudio() { audio.src = playlist[0]; audio.play().catch(() => {}); }
        function backToMain() { document.getElementById('content-page').classList.add('hidden'); enterMain(); }
    </script>
</body>
</html>
